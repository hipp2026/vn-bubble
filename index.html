
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>VN30 Bubble Map</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<style>
html,body{
  margin:0;
  padding:0;
  overflow:hidden;
  background:#0b0f1a;
  font-family:-apple-system,BlinkMacSystemFont,Inter,Roboto;
}
#hint{
  position:fixed;
  bottom:10px;
  left:50%;
  transform:translateX(-50%);
  color:#888;
  font-size:12px;
}
</style>
</head>
<body>

<div id="hint">Drag bubbles • Color = % change • Size = market cap</div>

<script src="https://cdn.jsdelivr.net/npm/pixi.js@7/dist/pixi.min.js"></script>
<script>

// =================== DATA (VN30 DEMO) ===================
const DATA = [
 {s:"VCB",p:1.8,cap:420},
 {s:"VIC",p:-0.9,cap:380},
 {s:"VHM",p:2.6,cap:360},
 {s:"FPT",p:3.2,cap:310},
 {s:"HPG",p:-1.4,cap:290},
 {s:"MWG",p:0.7,cap:240},
 {s:"CTG",p:1.1,cap:230},
 {s:"TCB",p:-2.2,cap:260},
 {s:"GAS",p:0.4,cap:210},
 {s:"SSI",p:4.1,cap:180},
 {s:"VPB",p:-3.6,cap:190},
 {s:"VNM",p:0.0,cap:220}
];

// =================== APP ===================
const app = new PIXI.Application({
  resizeTo:window,
  backgroundAlpha:0,
  antialias:true
});
document.body.appendChild(app.view);

const world = new PIXI.Container();
world.position.set(window.innerWidth/2, window.innerHeight/2);
app.stage.addChild(world);

// =================== UTILS ===================
const lerp=(a,b,t)=>a+(b-a)*t;
const noise=(x,y,t)=>Math.sin(x*0.002+t)+Math.cos(y*0.002-t);

// =================== SHADER ===================
precision mediump float;
varying vec2 vTextureCoord;

uniform vec3 color;
uniform float glow;

void main(){
  vec2 uv = vTextureCoord * 2.0 - 1.0;
  float d = length(uv);

  // cắt ngoài hình tròn
  if(d > 1.0) discard;

  // ===== alpha mềm =====
  float alpha = smoothstep(1.0, 0.85, d);

  // ===== viền bong bóng =====
  float rim = smoothstep(0.9, 1.0, d);

  // ===== highlight lệch =====
  vec2 lightDir = vec2(-0.35, -0.35);
  float highlight = smoothstep(0.3, -0.2, dot(uv, lightDir));

  // ===== lõi mờ =====
  float core = smoothstep(0.0, 0.5, d);

  // ===== màu =====
  vec3 col =
      color * (0.85 + highlight * 0.25)
    + rim * vec3(1.0) * 0.35
    + glow * 0.25;

  // giảm trắng ở tâm
  col *= (1.0 - core * 0.25);

  gl_FragColor = vec4(col, alpha);
}
// =================== BUBBLE ===================
class Bubble{
  constructor(d){
    this.d=d;
    this.x=(Math.random()-0.5)*600;
    this.y=(Math.random()-0.5)*400;
    this.vx=0; this.vy=0;
    this.fx=Math.random()*1000;
    this.fy=Math.random()*1000;

    this.currentColor=[0.6,0.6,0.6];

    this.mesh=new PIXI.Sprite(PIXI.Texture.WHITE);
    this.mesh.anchor.set(0.5);
    this.shader=bubbleShader();
    this.mesh.filters=[this.shader];
    this.mesh.interactive=true;
    this.mesh.cursor="pointer";

    this.drag=false;
    this.mesh
      .on("pointerdown",e=>{
        this.drag=true;
        this.data=e.data;
        this.vx=this.vy=0;
      })
      .on("pointerup",()=>this.drag=false)
      .on("pointerupoutside",()=>this.drag=false);

    // LABEL
    this.label=new PIXI.Text(d.s,{
      fill:"#fff",
      fontSize:12,
      fontWeight:"600"
    });
    this.label.anchor.set(0.5);

    world.addChild(this.mesh);
    world.addChild(this.label);
  }

  update(t){
    // size
    this.r=24+Math.log(this.d.cap+1)*6;
    this.mesh.width=this.mesh.height=this.r*2;
    this.shader.uniforms.radius=this.r;

    // color ramp
    let target;
    const pct=this.d.p;
    const m=Math.min(Math.abs(pct)/5,1);

    if(pct>0) target=[lerp(0.4,0.1,m),lerp(0.7,1,m),lerp(0.4,0.3,m)];
    else if(pct<0) target=[lerp(0.5,1,m),lerp(0.4,0.2,m),lerp(0.4,0.2,m)];
    else target=[0.6,0.6,0.6];

    for(let i=0;i<3;i++)
      this.currentColor[i]+= (target[i]-this.currentColor[i])*0.08;

    this.shader.uniforms.color=this.currentColor;
    this.shader.uniforms.glow=0.4+m*0.9;

    // drag
    if(this.drag){
      const p=this.data.getLocalPosition(world);
      this.x=p.x; this.y=p.y;
    }else{
      // flow
      const n=noise(this.fx,this.fy,t*0.0005);
      const a=n*Math.PI;
      this.vx+=Math.cos(a)*0.02;
      this.vy+=Math.sin(a)*0.02;
      this.fx++; this.fy++;

      // center pull
      this.vx+=-this.x*0.00012;
      this.vy+=-this.y*0.00012;

      this.x+=this.vx;
      this.y+=this.vy;
      this.vx*=0.985;
      this.vy*=0.985;
    }

    this.mesh.position.set(this.x,this.y);
    this.label.position.set(this.x,this.y);
  }
}

// =================== RUN ===================
const bubbles=DATA.map(d=>new Bubble(d));

app.ticker.add(t=>{
  bubbles.forEach(b=>b.update(t));
});

// =================== RESIZE ===================
window.addEventListener("resize",()=>{
  world.position.set(innerWidth/2,innerHeight/2);
});
</script>
</body>
</html>
