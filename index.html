<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>VN CryptoBubbles</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://d3js.org/d3.v7.min.js"></script>

<style>
html,body{
  margin:0;
  background:#0b1220;
  overflow:hidden;
  font-family:Inter,-apple-system,BlinkMacSystemFont,sans-serif;
  color:white;
}

#panel{
  position:fixed;
  top:10px;
  left:10px;
  background:#111827;
  padding:10px;
  border-radius:10px;
  z-index:10;
  font-size:12px;
}

#panel select,input{
  width:100%;
  margin-top:6px;
  background:#020617;
  color:white;
  border:1px solid #334155;
  border-radius:6px;
}

canvas{ display:block }

#tooltip{
  position:fixed;
  background:#111827;
  padding:10px;
  border-radius:10px;
  font-size:13px;
  pointer-events:none;
  opacity:0;
  box-shadow:0 10px 25px rgba(0,0,0,.4);
}
</style>
</head>

<body>

<div id="panel">
  <b>VN Bubble</b>
  <select id="indexFilter">
    <option value="VN30">VN30</option>
    <option value="VN100">VN100</option>
    <option value="VNALL">VNALL</option>
  </select>

  <select id="capFilter">
    <option value="ALL">All Cap</option>
    <option value="LARGE">Large</option>
    <option value="MID">Mid</option>
    <option value="SMALL">Small</option>
  </select>

  <label>% change ‚â•</label>
  <input type="range" min="-5" max="5" step="0.5" id="changeFilter">
</div>

<canvas id="canvas"></canvas>
<div id="tooltip"></div>

<script>
// ================= CANVAS SETUP =================
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const tooltip = document.getElementById("tooltip");

function resize(){
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}
resize();
window.addEventListener("resize",resize);

// ================= VN DATA (CHU·∫®N HO√Å GI·ªêNG CAFEF) =================
// üëâ Thay kh·ªëi n√†y b·∫±ng JSON th·∫≠t sau
const RAW_DATA = [
  {symbol:"VCB",price:98500,change:1.8,volume:18,cap:450000,index:["VN30","VN100","VNALL"]},
  {symbol:"BID",price:46200,change:-0.6,volume:15,cap:280000,index:["VN30","VN100","VNALL"]},
  {symbol:"CTG",price:33100,change:2.4,volume:22,cap:200000,index:["VN30","VN100","VNALL"]},
  {symbol:"FPT",price:141600,change:3.2,volume:12,cap:190000,index:["VN30","VN100","VNALL"]},
  {symbol:"HPG",price:28300,change:-1.2,volume:30,cap:170000,index:["VN30","VN100","VNALL"]},
  {symbol:"SSI",price:33000,change:-2.3,volume:28,cap:90000,index:["VN100","VNALL"]},
  {symbol:"NKG",price:23000,change:2.8,volume:35,cap:21000,index:["VNALL"]}
];

// ================= NORMALIZE =================
const ALL_DATA = RAW_DATA.map(d=>({
  ...d,
  marketCap:d.cap,
  r:0,
  pulse:0
}));

// ================= FILTER STATE =================
const FILTER = {
  index:"VN30",
  cap:"ALL",
  changeMin:-5
};

// ================= SCALES =================
const rScale = d3.scaleSqrt().domain([0,500000]).range([15,80]);
const color = d3.scaleLinear()
  .domain([-5,0,5])
  .range(["#dc2626","#475569","#22c55e"]);

// ================= FILTER PIPELINE =================
function filtered(){
  return ALL_DATA.filter(d=>{
    if(!d.index.includes(FILTER.index)) return false;
    if(FILTER.cap==="LARGE" && d.marketCap<100000) return false;
    if(FILTER.cap==="MID" && (d.marketCap<30000||d.marketCap>100000)) return false;
    if(FILTER.cap==="SMALL" && d.marketCap>30000) return false;
    if(d.change<FILTER.changeMin) return false;
    return true;
  });
}

// ================= FORCE SIM =================
const sim = d3.forceSimulation()
  .force("center",d3.forceCenter(canvas.width/2,canvas.height/2))
  .force("charge",d3.forceManyBody().strength(6))
  .force("collision",d3.forceCollide().radius(d=>d.r+4))
  .on("tick",draw);

function update(){
  const data = filtered();
  data.forEach(d=>d.r=rScale(d.marketCap));
  sim.nodes(data).alpha(1).restart();
}
update();

// ================= DRAW LOOP =================
function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);

  sim.nodes().forEach(d=>{
    // volume pulse
    d.pulse += d.volume*0.002;
    const pulseR = d.r + Math.sin(d.pulse)*3;

    ctx.beginPath();
    ctx.arc(d.x,d.y,pulseR,0,Math.PI*2);
    ctx.fillStyle = color(d.change);
    ctx.fill();

    ctx.fillStyle="white";
    ctx.textAlign="center";
    ctx.font="bold 14px Inter";
    ctx.fillText(d.symbol,d.x,d.y+4);
  });
}

// ================= INTERACTION =================
canvas.addEventListener("mousemove",e=>{
  const x=e.clientX,y=e.clientY;
  const hit = sim.nodes().find(d=>{
    const dx=x-d.x,dy=y-d.y;
    return Math.sqrt(dx*dx+dy*dy)<d.r;
  });

  if(hit){
    tooltip.style.opacity=1;
    tooltip.innerHTML=
      `<b>${hit.symbol}</b><br>
       Gi√°: ${hit.price}<br>
       %: ${hit.change}%<br>
       KL: ${hit.volume}<br>
       V·ªën: ${hit.marketCap}`;
    tooltip.style.left=x+15+"px";
    tooltip.style.top=y+15+"px";
  }else{
    tooltip.style.opacity=0;
  }
});

// ================= UI =================
indexFilter.onchange=e=>{FILTER.index=e.target.value;update();};
capFilter.onchange=e=>{FILTER.cap=e.target.value;update();};
changeFilter.oninput=e=>{FILTER.changeMin=+e.target.value;update();};

</script>
</body>
</html>
